# CtripDal
【前言】

随着企业规模扩张和业务量的急剧增加，作为系统核心的数据库相关开发也会经历一个由单一团队发展为多团队；由单机扩张到集群；由单数据库发展为多数据库；由采用单一数据库产品到多种数据库产品并存的过程。伴随这一过程的是如何管理数据库扩展，如何规范数据库访问，如何保护数据库投资，如何应对访问量增加，如何预防安全问题等一系列挑战。

为了应对这些挑战，携程前CTO叶亚明先生（现首席科学家）发起了携程10X提速战略规划。作为支持10X规划的一部分，携程开发了具有自己特色的数据库访问框架Ctrip DAL。Ctrip DAL框架的最初构想是由前携程系统研发部总监陈绍明先生（Simon Chen）提出，陈绍明同时组建了开发团队并决定了该框架的路线图和重大设计决策。

【简介】

Ctrip DAL支持流行的分库分表操作，支持Java和C#，支持MySQL和MS SQLServer。使用该框架可以在有效保护企业已有数据库投资的同时，迅速可靠地为企业提供数据库访问层的横向扩展能力。整个框架包括代码生成器和客户端。工作模式是使用代码生成器在线生成代码，通过DAL客户端完成数据库操作。生成器具有丰富的向导指引，操作简单清晰，既可以批量生成标准DAO，也可以在方法级别定制数据库访问。客户端则可以简单地通过标准的maven方式添加依赖。

<image   src='\Images\20161008162044851.png'></image>

Ctrip DAL与一般数据库框架最大的不同是从企业跨部门的角度，统一管理数据库相关资源。通过部署代码生成器，企业可以做到有效管理全公司的DAL开发团队，明确数据库归属和定制数据库访问。通过代码生成器生成的标准DAO代码与客户端配合使用，可以大幅提高工作效率，保证代码质量。解决了业内常见的伴随业务成长而带来的系统维护困难、开发效率低下、代码风格五花八门、代码质量参差不齐等痛点问题。

【使用】

CtripDal 的使用简单来说可以分成两部分：

一.代码生成器

1，下载项目源码，然后打成war包，部署到自己的服务器上启动。
下载地址：https://github.com/ctripcorp/dal.git

2，如果各位觉得下载源码比较麻烦，可以直接下载打包好的ROOT.war，部署到自己的服务器上即可。下载地址：http://download.csdn.net/detail/hejiehui/9650838

这里我说明一下：

(1)源码下载后在我的工程里一直报错，引入了缺失的包还是一样，所以我采用的是上面的方法2，直接下载ROOT.war包。

(2)该项目只适用于tomcat 7，我用的是apache-tomcat-7.0.68，可以正常启动。

(3)删除tomcat webapps中所有内容，将ROOT.war部署进去，启动tomcat，访问http://localhost:8080

成功后可以进入如下页面，这里需要填写可用的数据库地址，连接测试成功后点击下一步：

由于是第一次登陆，以下的所有信息都可以随便填写，保证数据库连接可用即可，方便后面做测试。

<image src='\Images\20170303093252017.png'></image>

然后按照说明填写以下信息，点击“保存”，CodeGen的初始化工作已全部完成。
* DB Catalog：选择要保存CodeGen数据的数据库 
* Team Name：请输入DAL Admin Team的名称(DAL Admin Team是CodeGen系统的管理员组，拥有最高的权限) 
* Comment：对Team Name的注释 
* Admin No：管理员工号(该帐号为DAL Admin Team的初始管理员) 
* Name：管理员姓名 
* Email：管理员电子邮箱地址 
* Password：管理员密码，用于登录CodeGen系统(后台以MD5加密方式存储) 

<image src='\Images\20170303093352252.png'></image>

此时直接点击保存会保存失败，如下图：

<image src='\Images\20170303093437534.png'></image>

* 这是因为这里所填写的信息是要保存到刚刚填写的数据库里面的，必须先在数据库建好项目需要的表。


解决办法：

找到你的tomcat按照目录下面的script.sql 文件，在你的数据库中执行脚本，

我的目录是：H:\tools\code-gen-eclipse\apache-tomcat-7.0.68\webapps\ROOT\WEB-INF\classes\script.sql

执行成功后可以看到以下几个表目录：

<image src='\Images\20170303093503034.png'></image>

表建好以后再继续上一步的操作，点击保存，成功进入登录页面。

这里可以用上一步填写的用户名密码登录，也可以再创建账号后登录。

<image src='\Images\20170303093628691.png'></image>

成功登录后进入主页：

<image src='\Images\20170303093653695.png'></image>

这里大家可以去查看数据库，创建的两个账号已经保存在login_users表中：

<image src='\Images\20170303093718410.png'></image>

接下来的事情就是如何生成自己的代码了， 
由于原文已经说得很清楚了，我这里不做介绍，大家可以访问这里：代码生成器使用说明

上图是代码生成完成后的界面，列表里可以看到自己生成的代码，方便管理，完整代码如下：

<image src='\Images\20170303094920994.png'></image>

二.下载生成好的代码，集成到自己的项目中

在上图中，大家可以看到已经生成好的代码结构，只有dao class 跟 entity class，没有dao interface。

接下来就是将代码拷贝到自己的工程里面了。

(1) 需要依赖携程提供的客户端的包，由于是maven工程，大家可以直接添加依赖到pom.xml中

配置如下：

<image src='\Images\20170718181225.png'></image>

(2) web.xml 中添加

<image src='\Images\20170718181421.png'></image>

(3) 将生成的dao 和 entity 拷贝到自己的目录下面 
(4) 将配置文件 dal.xml , datasource.xml 拷贝到resource目录下面

(5) demo project ：https://github.com/ctripcorp/dal/blob/master/doc/dal-demo.zip

到此就已经完成了，项目依赖jdk1.7，如果使用的jdk1.8可以向下兼容，关于代码的生成大家就可以自己多测试测试了。
